---
title: multiarch-readiness-report
authors:
  - "@aleskandro"
reviewers:
  - "@AnnaZivkovic"
  - "@jeffdyoung"
  - "@lwan-wanglin"
  - "@Prashanth684"
approvers:
  - "@Prashanth684"
creation-date: 2025-04-23
last-updated: 2025-04-23
tracking-link:
  - https://issues.redhat.com/browse/MULTIARCH-5010
see-also: []
---

# Multi-architecture cluster readiness report

## Summary

The Multiarch Tuning Operator automatically configures pod node affinities to ensure workloads are scheduled on nodes with compatible CPU architectures based on the architectures supported by the images they use.

This enhancement proposes the introduction of a new custom resource that will allow users to generate a multi-architecture cluster readiness report. This report will provide insights into the architecture compatibility of workloads across the cluster, enabling administrators to identify potential issues and take corrective actions proactively before they impact the availability, reliability or performance of their clusters and Service Level Objectives (SLOs).

### User Stories

- As a cluster administrator that wants to migrate their cluster to multi-architecture nodes, I want to be informed about
risks and issues related to the architecture compatibility of workloads across the cluster, so that I can take corrective actions proactively before they impact the availability, reliability or performance of my clusters and Service Level Objectives (SLOs).

### Goals

- Generate a report that provides insights into the architecture compatibility of workloads across the cluster.

### Non-Goals

- Automatically resolve issues related to architecture compatibility of workloads across the cluster.

## Proposal

We introduce a new cluster-scoped custom resource, `multiarchReadinessReport`, that will be used to generate a multi-architecture cluster readiness report. This custom resource will be created by a user willing to generate the report. The report will be generated by a Job created by the Multiarch Tuning Operator and will contain information about the architecture compatibility of workloads across the cluster.

The implementation will be split into two phases:
1. **Phase 1**: Implement the `multiarchReadinessReport` custom resource and the Job that will generate the report. The report will be generated in a JSON format and will be stored in the status field of the custom resource. It will contain information about the architecture compatibility of workloads across the cluster, including:
   - The number of pods that are not compatible with each possible node architecture (i.e., x86_64, aarch64, ppc64le, s390x).
   - A mapping of each image used by the pods to its supported architectures and workload that uses it.
2. **Phase 2**: Additional features and enhancements to the report, such as
   - Classification of pods and related images into different categories based on their scope (e.g., CSI, CNI, device plugin, operator, user workloads). Phase 2 will not be described in this document and will require a separate enhancement proposal.

## Architecture

### MultiarchReadinessReport API definition

```yaml
apiVersion: multiarch.openshift.io/v1beta1
kind: MultiarchReadinessReport
metadata:
  name: <uuid>
  namespace: <multiarch-tuning-operator-namespace>
spec: {}
status:
  phase: <Pending|Running|Completed|Failed>
  images:
    - name: registry.io/app/image:v1.2.3
      multiarch: true
      supportedArchitectures:
        - amd64
        - arm64
      references:
      - namespace: my-namespace
        podName: my-pod-name
        owner:
          kind: Deployment
          name: my-deployment
          namespace: my-namespace
    - name: registry.io/legacy/backend:latest
      multiarch: false
      supportedArchitectures:
        - amd64
  workloads:
  - kind: Deployment
    name: my-deployment
    namespace: my-namespace
    multiarch: true
    supportedArchitectures:
    - arm64
    - amd64
  summary:
    multiarchImages: Int
    singlearchImages: Int
    multiarchWorkloads: Int
    singlearchWorkloads: Int
```


This definition allows the user to query and parse the report using the `kubectl` command. As an example, users can process the yaml by specifically querying the images that are not multi-architecture compatible:

```bash
kubectl get multiarchreadinessreport -o jsonpath='{.status.images[?(@.multiarch==false)]}'
```

Or to get all the workloads that are not multi-architecture compatible:

```bash
kubectl get multiarchreadinessreport -o jsonpath='{.status.workloads[?(@.multiarch==false)]}'
```

## Changes to the ClusterPodPlacementConfig CRD

None 

## Changes to the Multiarch Tuning Operator

A new controller will be added to the Multiarch Tuning Operator to handle the `MultiarchReadinessReport` custom resource. This controller will be responsible for creating a Job that will generate the report and update the status of the custom resource with the generated report.

The Job - `multiarch-readiness-report-gen` - will be created in the same namespace as the Multiarch Tuning Operator. The job will use the Kubernetes API to gather information about the pods and their images across the cluster. The report will be stored in the status field of the custom resource.


## The multiarch-readiness-report-gen Job

The `multiarch-readiness-report-gen` Job will be responsible for generating the multi-architecture cluster readiness report. The Job will be created by the Multiarch Tuning Operator when a user creates a `MultiarchReadinessReport` custom resource.

When pods have owner references, the Job will use the owner references to determine the kind of workload that owns the pod. The Job will consider owner references of the following kinds:
- Pod -> ReplicaSet -> Deployment
- Pod -> StatefulSet
- Pod -> DaemonSet
- Pod -> Job
- Pod -> Job -> CronJob
- Pod -> ReplicationController
- Pod -> ReplicaSet -> Deployment -> DeploymentConfig (only OCP)

The job will traverse the owner references starting from the pod and will stop when it finds an object that has no owner references or whose owner references are not among the above (i.e., non-readable given the RBACs of the job). The job will then use the kind and name of the highest-level found object to determine the kind of workload that owns the pod and to return the information in the report. This ensures that the report contains accurate and useful enough information, despite the fact that some workloads may be owned by custom resources
 unknown to the operator (e.g., CRDs from other operators).

## Changes to the Pod Placement Controller

None

## Changes to the Mutating Webhook

None

## RBAC

The operator will gain a new permission to create jobs in the same namespace as the operator. It will also have permissions to reconcile the `MultiarchReadinessReport` custom resource. 

The job will be allowed the following permissions:

| Resource               | Methods   | comments         |
|------------------------|-----------|------------------|
| pods                   | list, get | (cluster-scoped) | 
| replicasets            | list, get | (cluster-scoped) |
| replicationcontrollers | list, get | (cluster-scoped) |
| deployments            | list, get | (cluster-scoped) |
| statefulsets           | list, get | (cluster-scoped) |
| daemonsets             | list, get | (cluster-scoped) |
| jobs                   | list, get | (cluster-scoped) |
| cronjobs               | list, get | (cluster-scoped) |
| deploymentconfigs      | list, get | (cluster-scoped) |



#### Considerations for Uninstallation

No changes are required to the existing uninstallation process. Users are still advised to delete all Multiarch Tuning Operator resources before uninstalling the operator. If these resources are not removed beforehand, the operands (such as DaemonSets or Deployments) may continue to run, but any changes to the configuration objects will no longer produce the expected behavior.

### Implementation Details and Design Constraints

- Paging[^1] will be used by the `multiarch-readiness-report-gen` Job to query the pods so that we can limit the number of concurrent requests to the Kubernetes API and the utilized memory. This is important to avoid overwhelming the API server and ensure that the Job can complete successfully without hitting rate limits.

### Risks and Mitigations

### Drawbacks

### Open Questions

### Test Plan

#### Unit Testing and Integration Test Suites

- Unit Testing: Test each new function, method, and feature in isolation to ensure correctness, reliability, and
  robustness. Ensure that all new code paths are adequately covered and that the code behaves as expected under various conditions.
- Integration Test Suite: Run integration tests against a simulated control plane using the operator SDK's envtest
  facilities. We will add the necessary test cases to ensure the reconciliation loop of the new `MultiarchReadinessReport` CRD is correctly handled
- An additional test suite will be created to validate the functionality of the `multiarch-readiness-report-gen` Job. This suite will include tests for the following scenarios:
  - Successful report generation when the Job has access to all necessary resources.
  - Handling of errors when the Job encounters inaccessible resources or other issues during report generation.
  - Validation of the generated report format and content, ensuring it meets the specified requirements and accurately reflects the architecture compatibility of workloads across the cluster.

#### Functional Test Suite

- The E2E tests will be extended to include tests for the new `MultiarchReadinessReport` CRD and the `multiarch-readiness-report-gen` Job. These tests will cover the following scenarios:
  - Creation of a `MultiarchReadinessReport` custom resource and verification of the generated report.
  - Validation of the report content, ensuring it accurately reflects the architecture compatibility of workloads across the cluster.
  - Testing the behavior of the Job under various conditions, such as imagePullSecrets and network policies.

### Graduation Criteria

The `ENoExecEvent` CRD will be introduced as `v1beta1`.

### Upgrade / Downgrade Strategy

No special upgrade or downgrade procedures are required for this enhancement. Users will upgrade to a new version of the Multiarch Tuning Operator that includes support for the `multiarchReadinessReport` CRD. 


### Operational Aspects of API Extensions

#### Failure Modes

## Documentation Plan

A new section will be added to the Multiarch Tuning Operator documentation to explain the new feature.

## Implementation History

## Infrastructure Needed

## References

[^1]: https://pkg.go.dev/k8s.io/client-go/tools/pager
